<div class="main-container container-fluid">
  <div class="col-auto justify-content-center align-content-center h-100">
    <h1 class="d-flex my-2 align-items-center mb-4">
      <i class="pi pi-chevron-left me-3 go-back-buttom" (click)="goHome()"></i> Editar Perfil
    </h1>
    <p-card>
      <div class="p-fluid p-4" [formGroup]="editUserForm">
        <div class="row mb-4 profile-data">
          <div class="col-auto image-container text-center">
            <!-- Imagen actual -->
            @if(userImage){
            <img [src]="userImage" alt="Imagen de Perfil" class="p-shadow-3 profile-img" height="150" width="150" />
            }@else {
            <i class="pi pi-user" style="font-size: 5rem"></i>
            }
            <label for="fileInput" class="upload-btn">
              <i class="pi pi-pencil p-2" style="font-size: 2rem"></i>
            </label>
            <input id="fileInput" type="file" accept=".jpg,.png,.jpeg" (change)="onFileSelected($event)" hidden />
          </div>
          <div class="col-auto justify-content-center align-content-center align-items-center text-start">
            <h2 class="m-0">{{ this.editUserForm.get('nombreApellido')?.value ?? '' }}</h2>
            <h4 class="m-0 text-secondary">{{ this.editUserForm.get('alias')?.value ?? '' }}</h4>
            <h4 class="m-0 text-secondary">{{ this.originalData?.correo ?? '' }}</h4>
          </div>
        </div>
        <!-- Campos de Información Personal -->
        <div class="row w-100">
          <div class="col-12 col-sm-12 col-md-6 mb-4">
            <label for="fullName">{{
              isOrganization ? 'Nombre de la organización' : 'Nombre y apellido'
              }}<span style="color: red;">&ensp;*</span></label>
            <input class="w-100" id="fullName" type="text" pInputText formControlName="nombreApellido"
              placeholder="Ingresa tu nombre y apellido" fluid />
            @if (editUserForm.get('nombreApellido')?.invalid &&
            editUserForm.get('nombreApellido')?.touched &&
            editUserForm.get('nombreApellido')?.dirty) {
            <div class="row mt-1">
              <p-message severity="error" size="small" variant="simple">
                Ingrese un nombre válido.
              </p-message>
            </div>
            }
          </div>
          <div class="col-12 col-sm-12 col-md-6 mb-4">
            <label for="alias">Alias<span style="color: red;">&ensp;*</span></label>
            <input class="w-100" id="alias" type="text" pInputText formControlName="alias"
              placeholder="Ingresa tu alias" fluid />
            @if (editUserForm.get('alias')?.invalid && editUserForm.get('alias')?.touched &&
            editUserForm.get('alias')?.dirty) {
            <div class="row mt-1">
              <p-message severity="error" size="small" variant="simple">
                Ingrese un alias válido.
              </p-message>
            </div>
            }
          </div>
        </div>
        <div class="row w-100">
          <div class="col-12 col-sm-12 col-md-6 mb-4">
            <label for="birthDate">{{
              isOrganization ? 'Fecha de fundación' : 'Fecha de Nacimiento'
              }}</label>
            <p-datepicker [maxDate]="today" class="mt-1" id="birthDate" formControlName="fechaNacimiento"
              dateFormat="dd/mm/yy" [showIcon]="true" inputId="icon" fluid></p-datepicker>
          </div>
          <!-- <div class="col-12 col-sm-12 col-md-6 mb-4 password-form">
            <label for="password">Contraseña</label>
            <p-inputgroup>
              <p-password
                class="mt-1"
                id="contrasena"
                formControlName="contrasena"
                placeholder="Crea una contraseña"
                weakLabel="Muy simple"
                mediumLabel="Medianamente segura"
                strongLabel="Compleja"
                promptLabel="Ingrese una contraseña"
                [feedback]="true"
                [disabled]="!editPassword"
                [toggleMask]="true"
                [invalid]=" originalData.contrasena != null && (
                  editUserForm.get('contrasena')?.invalid &&
                  editUserForm.get('contrasena')?.touched &&
                  editUserForm.get('contrasena')?.dirty)
                "
                fluid
              >
                <ng-template #footer>
                  <p-divider />
                  <ul class="ms-2 p-0 leading-normal" style="list-style: none">
                    <li class="d-block items-center">
                      @if(editUserForm.get('contrasena')?.getError('minlength') ||
                      editUserForm.get('contrasena')?.getError('required')){
                      <i class="pi pi-times-circle me-1" style="color: red"></i>
                      }@else{
                      <i class="pi pi-check-circle me-1" style="color: green"></i>
                      } Mínimo 8 caracteres
                    </li>
                    <li class="d-flex items-center">
                      @if(editUserForm.get('contrasena')?.getError('missingSpecialChar') ||
                      editUserForm.get('contrasena')?.getError('required')){
                      <i class="pi pi-times-circle me-1" style="color: red"></i>
                      }@else{
                      <i class="pi pi-check-circle me-1" style="color: green"></i>
                      } Símbolos (ej. !@#$)
                    </li>
                    <li class="d-flex items-center">
                      @if(editUserForm.get('contrasena')?.getError('missingUpperCase') ||
                      editUserForm.get('contrasena')?.getError('required')){
                      <i class="pi pi-times-circle me-1" style="color: red"></i>
                      }@else{
                      <i class="pi pi-check-circle me-1" style="color: green"></i>
                      } Al menos una mayúscula
                    </li>
                    <li class="d-flex items-center">
                      @if(editUserForm.get('contrasena')?.getError('missingNumber') ||
                      editUserForm.get('contrasena')?.getError('required')){
                      <i class="pi pi-times-circle me-1" style="color: red"></i>
                      }@else{
                      <i class="pi pi-check-circle me-1" style="color: green"></i>
                      } Números
                    </li>
                  </ul>
                </ng-template>
              </p-password>
              <p-button [label]="editPassword? 'Ok' : 'Cambiar'" (onClick)="editPassword = !editPassword" />
            </p-inputgroup>
          </div> -->
          @if(!isOrganization){
          <div class="col-12 col-sm-12 col-md-6 mb-4">
            <label for="roles">Selecciona los roles que desea tener<span style="color: red;">&ensp;*</span></label>
            <div class="text-center">
              <p-selectbutton class="mt-1" fluid id="roles" formControlName="roles" [options]="userRolesOptions"
                [multiple]="true" optionLabel="label" optionValue="value" />
              @if(editUserForm.get('roles')?.invalid && editUserForm.get('roles')?.dirty){
              <div class="row mt-1">
                <p-message severity="error" size="small" variant="simple">Seleccione al menos un rol.
                </p-message>
              </div>
              }
            </div>
          </div>
          }
          @if(isOrganization){
          <div class="col-12 col-sm-12 col-md-6 mb-4">
            <label>Documentos de respaldo (PDF)</label>
            <div class="row mt-3 w-100 m-0">
              @if(documentoActual && !originalData?.validado){
                <div class="col-12 col-sm-12 col-md-6 mb-3 mb-md-0">
                  <div class="card p-3 h-100">
                    <div class="d-flex align-items-center justify-content-between mb-2">
                      <div class="d-flex align-items-center">
                        <i class="pi pi-file-pdf me-2" style="font-size: 1.5rem; color: #e74c3c;"></i>
                        <div>
                          <p class="m-0"><strong>{{ documentoActual.nombre }}</strong></p>
                          <small class="text-secondary">{{ documentoActual.fechaSubida }}</small>
                        </div>
                      </div>
                    </div>
                    <div class="d-flex gap-2">
                      <p-button icon="pi pi-download" [rounded]="true" [outlined]="true" 
                        (onClick)="downloadDocument()" severity="info" />
                      <p-button icon="pi pi-eye" [rounded]="true" [outlined]="true" 
                        (onClick)="viewDocument()" />
                    </div>
                  </div>
                </div>
                <div class="col-12 col-sm-12 col-md-6">
                  <label class="mb-2">Cambiar documento</label>
                  <p-fileupload
                    name="pdfDocuments"
                    styleClass="w-100"
                    [multiple]="false"
                    accept=".pdf,application/pdf"
                    maxFileSize="52428800"
                    mode="advanced"
                    (onSelect)="setPdfFile($event)"
                    (onClear)="clearPdfFile()"
                    [files]="uploadedPdfFiles"
                  >
                    <ng-template #empty>
                      <div class="row justify-content-md-center">
                        <div class="col-md-auto">Arrastra un PDF para reemplazar</div>
                      </div>
                    </ng-template>
                    <ng-template #file>
                      @if(uploadedPdfFiles.length == 0){
                      <div class="row justify-content-md-center">
                        <div class="col-md-auto">Arrastra un PDF para reemplazar</div>
                      </div>
                      } @for (file of uploadedPdfFiles; track $index) {
                      <div class="row justify-content-md-center align-items-center">
                        <div class="col-md-auto">
                          <i class="pi pi-file-pdf" style="font-size: 3rem; color: #e74c3c;"></i>
                        </div>
                        <div class="col">
                          <div class="row">
                            <strong>{{ file.name }}</strong>
                          </div>
                          <div class="row">{{ (file.size / 1024 / 1024).toFixed(2) }} MB</div>
                        </div>
                      </div>
                      }
                    </ng-template>
                    <ng-template
                      #header
                      let-files
                      let-chooseCallback="chooseCallback"
                      let-clearCallback="clearCallback"
                    >
                      <div class="justify-between items-center">
                        <div class="flex">
                          <p-button
                            class="me-2"
                            (onClick)="chooseCallback($event, chooseCallback)"
                            icon="pi pi-file-pdf"
                            [rounded]="true"
                            [outlined]="true"
                          />
                          <p-button
                            (onClick)="clearCallback()"
                            icon="pi pi-times"
                            [rounded]="true"
                            [outlined]="true"
                            severity="danger"
                            [disabled]="!files || files.length === 0"
                          />
                        </div>
                      </div>
                    </ng-template>
                  </p-fileupload>
                </div>
              }
              @if(documentoActual && originalData?.validado){
                <div class="col-12">
                  <div class="card p-3 bg-light h-100">
                    <div class="d-flex align-items-center justify-content-between mb-2">
                      <div class="d-flex align-items-center">
                        <i class="pi pi-file-pdf me-2" style="font-size: 1.5rem; color: #e74c3c;"></i>
                        <div>
                          <p class="m-0"><strong>{{ documentoActual.nombre }}</strong></p>
                          <small class="text-secondary">{{ documentoActual.fechaSubida }}</small>
                        </div>
                      </div>
                      <span class="badge bg-success">Validado</span>
                    </div>
                    <div class="d-flex gap-2">
                      <p-button icon="pi pi-download" [rounded]="true" [outlined]="true" 
                        (onClick)="downloadDocument()" severity="info" label="Descargar" />
                      <p-button icon="pi pi-eye" [rounded]="true" [outlined]="true" 
                        (onClick)="viewDocument()" label="Ver" />
                    </div>
                  </div>
                </div>
              }
              @if(!documentoActual && !originalData?.validado){
                <div class="col-12">
                  <label class="mb-2">Subir documento de respaldo</label>
                  <p-fileupload
                    name="pdfDocuments"
                    styleClass="w-100"
                    [multiple]="false"
                    accept=".pdf,application/pdf"
                    maxFileSize="52428800"
                    mode="advanced"
                    (onSelect)="setPdfFile($event)"
                    (onClear)="clearPdfFile()"
                    [files]="uploadedPdfFiles"
                  >
                    <ng-template #empty>
                      <div class="row justify-content-md-center">
                        <div class="col-md-auto">Arrastra un PDF para subir</div>
                      </div>
                    </ng-template>
                    <ng-template #file>
                      @if(uploadedPdfFiles.length == 0){
                      <div class="row justify-content-md-center">
                        <div class="col-md-auto">Arrastra un PDF para subir</div>
                      </div>
                      } @for (file of uploadedPdfFiles; track $index) {
                      <div class="row justify-content-md-center align-items-center">
                        <div class="col-md-auto">
                          <i class="pi pi-file-pdf" style="font-size: 3rem; color: #e74c3c;"></i>
                        </div>
                        <div class="col">
                          <div class="row">
                            <strong>{{ file.name }}</strong>
                          </div>
                          <div class="row">{{ (file.size / 1024 / 1024).toFixed(2) }} MB</div>
                        </div>
                      </div>
                      }
                    </ng-template>
                    <ng-template
                      #header
                      let-files
                      let-chooseCallback="chooseCallback"
                      let-clearCallback="clearCallback"
                    >
                      <div class="justify-between items-center">
                        <div class="flex">
                          <p-button
                            class="me-2"
                            (onClick)="chooseCallback($event, chooseCallback)"
                            icon="pi pi-file-pdf"
                            [rounded]="true"
                            [outlined]="true"
                          />
                          <p-button
                            (onClick)="clearCallback()"
                            icon="pi pi-times"
                            [rounded]="true"
                            [outlined]="true"
                            severity="danger"
                            [disabled]="!files || files.length === 0"
                          />
                        </div>
                      </div>
                    </ng-template>
                  </p-fileupload>
                </div>
              }
            </div>
          </div>
          }
        </div>
        <!-- @if(!isOrganization){
        <div class="row w-100">
          <div class="col-12 col-sm-12 col-md-6 mb-4">
            <label for="roles">Selecciona los roles que desea tener</label>
            <div class="text-center">
              <p-selectbutton
                class="mt-1"
                fluid
                id="roles"
                formControlName="roles"
                [options]="userRolesOptions"
                [multiple]="true"
                optionLabel="label"
                optionValue="value"
              />
              @if(editUserForm.get('roles')?.invalid && editUserForm.get('roles')?.dirty){
              <p-message severity="error" size="small" variant="simple"
                >Seleccione al menos un rol.</p-message
              >
              }
            </div>
          </div>
        </div>
        } -->
        <div class="row w-100 justify-content-end">
          <div class="col-auto mt-4">
            <p-button class="me-4" label="Cancelar" severity="secondary" (onClick)="cancel()"
              [disabled]="editUserForm.pristine && !changedImage" />
            <p-button label="Guardar" (onClick)="onSubmit()"
              [disabled]="(editUserForm.pristine && !changedImage) || editUserForm.invalid" />
          </div>
        </div>
      </div>
    </p-card>
  </div>
</div>