<div class="main-container container-fluid p-0">
  <div class="container-fluid d-flex flex-column justify-content-start align-items-stretch h-100 p-0">
    <div class="d-flex align-items-center p-0 py-2 flex-shrink-0 chat-header mb-2">
      <div class="col-auto ms-2 justify-content-center d-flex" (click)="goBack()">
        <i class="pi pi-chevron-left go-back-buttom"></i>
      </div>
      <div class="col-auto mx-2">
        @if(userChat?.urlImagen){
        <p-avatar size="large" shape="circle" [image]="userChat?.urlImagen" />
        }@else {
        <p-avatar size="large" shape="circle" icon="pi pi-user" />
        }
      </div>
      <div class="col-auto d-block user-display-info">
        <div>
          <span class="fw-medium fs-4">
            {{ userChat?.alias }}
          </span>
        </div>
        <span class="fw-medium text-secondary fs-6">
          {{ userChat?.nombreApellido }}
        </span>
      </div>
      <div class="col-auto d-block mx-2 mx-xl-4">
        <i class="pi pi-angle-double-right" style="font-size: 1.5rem"></i>
      </div>
      <div class="col-auto me-2">
        @if(chat?.solicitud.producto.urlImagen){
        <p-avatar size="large" shape="circle" [image]="chat?.solicitud.producto.urlImagen" />
        }@else {
        <p-avatar size="large" shape="circle" icon="pi pi-box"/>
        }
      </div>
      <div class="col-auto d-block product-display-info">
        <div>
          <span class="fw-medium fs-4">
            {{ chat?.solicitud.producto.nombre }}
          </span>
        </div>
        <span class="fw-medium text-secondary fs-6">
          {{ chat?.solicitud.producto.categoria.nombre }}
        </span>
      </div>
      <div class="col d-flex justify-content-end me-2">
        <p-button label="Finalizar chat" variant="outlined" severity="danger" raised="true" [rounded]="true"
          (click)="openCloseChatDialog()" [disabled]="chat?.estado != 'PENDIENTE'" />
      </div>
    </div>
    <div class="d-flex p-0 flex-grow-1 overflow-hidden">
      <div class="col d-flex flex-column p-0 h-100 w-100">
        <div #messagesContainer class="row d-block w-100 flex-grow-1 overflow-auto"
          style="height: 80%; max-height: 80%">
          @for (message of messages; track $index) {
          <div [ngClass]="
              message.usuario.id == logedUser.id ? 'text-start ms-auto' : 'text-start me-auto'
            " [class.mt-2]="$index != 0" class="message-container p-2">
            <p class="fw-medium">{{ message.mensaje }}</p>
            <div class="text-end">
              <span class="fw-medium text-secondary">{{
                message.fechaMensaje | date : 'HH:mm'
                }}</span>
            </div>
          </div>
          }
        </div>
        <div class="row w-100 mt-2" style="height: 20%; margin-bottom: 0.5rem;">
          <div class="col p-0">
            <textarea placeholder="Escribe un mensaje..." maxlength="255" pTextarea fluid [(ngModel)]="message"
              (keydown.enter)="sendMessage($event)" style="min-height: 100%; max-height: 100%; resize: none"
              [disabled]="chat?.estado != 'PENDIENTE'"></textarea>
          </div>
          <div class="col-auto d-inline-grid justify-content-center align-content-start align-items-center p-2 gap-1">
            <p-button icon="pi pi-send" variant="outlined" raised="true" [rounded]="true" (click)="sendMessage()"
              [disabled]="!message.trim() || chat?.estado != 'PENDIENTE'" />
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<p-confirmdialog>
  <ng-template #headless let-message let-onAccept="onAccept" let-onReject="onReject">
    <div class="d-flex flex-column align-items-center p-4 rounded position-relative">

      <!-- Círculo con ícono -->
      <div class="rounded-circle d-flex justify-content-center align-items-center"
        style="height: 96px; width: 96px; position: absolute; top: -48px; background-color: var(--p-menu-background);">
        <i class="pi pi-question fs-1"></i>
      </div>

      <!-- Contenido -->
      <div class="mt-5 pt-4 text-center">
        <span class="fw-bold fs-3 d-block mb-2">{{ message.header }}</span>
        <p class="mb-0">{{ message.message }}</p>

        <!-- Botones -->
        <div class="d-flex justify-content-center align-items-center gap-2 mt-4">
          <p-button label="Entregado" fluid (click)="delivered = true; onAccept()" />
          <p-button label="Rechazado" fluid severity="warn" (click)="delivered = false; onAccept()" />
          <p-button label="Cancelar" fluid outlined="true" (click)="onReject()" />
        </div>
      </div>
    </div>
  </ng-template>
</p-confirmdialog>