import{a as oe,b as se}from"./chunk-JQLK4AHE.js";import{a as ce}from"./chunk-A6NZNUHX.js";import{a as le}from"./chunk-SGMXIVTQ.js";import"./chunk-DVFEINU7.js";import{b as ie}from"./chunk-R4M2EAJZ.js";import{a as ee,b as te}from"./chunk-CYTZBTDE.js";import{a as ne,b as re}from"./chunk-T4MU4AB4.js";import{a as ae}from"./chunk-DW6VR7TT.js";import{a as Y}from"./chunk-D5OLY3RM.js";import{C as Z,D as K,b as Q,e as q,i as W,m as G,n as J}from"./chunk-CQCVERZP.js";import{ba as x}from"./chunk-4G3JCKZK.js";import"./chunk-4O3FVBGX.js";import{D as X,b as B,c as L,h as F,l as H,x as $}from"./chunk-QOJUQ6XD.js";import{$b as V,Bb as C,Bc as A,Cb as y,Db as k,Ec as U,Fb as M,Gb as T,Hb as g,Ib as a,Jb as n,Kb as p,Rb as w,Wb as h,Xb as f,Za as s,ac as N,bc as j,ea as l,gc as I,ja as c,jb as S,jc as d,ka as m,kc as _,lc as b,nc as P,oc as R,pb as E,pc as z,qc as D,zc as O}from"./chunk-A4JG42N6.js";var de=["messagesContainer"];function ue(r,t){if(r&1&&p(0,"p-avatar",8),r&2){let i=f();g("image",i.userChat==null?null:i.userChat.urlImagen)}}function pe(r,t){r&1&&p(0,"p-avatar",9)}function he(r,t){if(r&1&&p(0,"p-avatar",8),r&2){let i=f();g("image",i.chat==null?null:i.chat.solicitud.producto.urlImagen)}}function ge(r,t){r&1&&p(0,"p-avatar",16)}function fe(r,t){if(r&1&&(a(0,"div",29)(1,"p",30),d(2),n(),a(3,"div",31)(4,"span",32),d(5),O(6,"date"),n()()()),r&2){let i=t.$implicit,e=t.$index,o=f();I("mt-2",e!=0),g("ngClass",i.usuario.id==o.logedUser.id?"text-start ms-auto":"text-start me-auto"),s(2),_(i.mensaje),s(3),_(A(6,5,i.fechaMensaje,"HH:mm"))}}function ve(r,t){if(r&1){let i=w();a(0,"div",33)(1,"div",34),p(2,"i",35),n(),a(3,"div",36)(4,"span",37),d(5),n(),a(6,"p",38),d(7),n(),a(8,"div",39)(9,"p-button",40),h("click",function(){let o=c(i).onAccept,u=f();return u.delivered=!0,m(o())}),n(),a(10,"p-button",41),h("click",function(){let o=c(i).onAccept,u=f();return u.delivered=!1,m(o())}),n(),a(11,"p-button",42),h("click",function(){let o=c(i).onReject;return m(o())}),n()()()()}if(r&2){let i=t.$implicit;s(5),_(i.header),s(2),_(i.message)}}var me=class r{messagesContainer;loginService=l(Y);permissionsService=l(ae);messagesService=l(ce);roomService=l(le);confirmationService=l(x);toasts=l(X);router=l($);location=l(B);messageSubscription;notificationService=l(ie);logedUser;chat;userChat;message="";messages=[];delivered=!1;subscribeToMessages(){this.messageSubscription&&this.messageSubscription.unsubscribe(),this.messageSubscription=this.messagesService.messages$.subscribe({next:t=>{t&&t.mensaje&&this.messages.push(t)}})}scrollToBottom(){try{let t=this.messagesContainer.nativeElement;t.scrollTop=t.scrollHeight}catch{}}ngOnInit(){this.loginService.getLoggedUser().subscribe(t=>{if(this.logedUser=t,t==null){this.router.navigate(["/login"]);return}if(!this.permissionsService.canAccessRoute(t,this.router.url)){this.router.navigate(["/principal"]);return}}),this.roomService.chat$.subscribe(t=>{if(!t){this.router.navigate(["principal/chats"]);return}this.chat=t,t.solicitud.donador.id==this.logedUser.id?this.userChat=t.solicitud.solicitante:this.userChat=t.solicitud.donador,this.messagesService.joinRoom(this.chat.nombreSala),this.loadChatMessages(),this.subscribeToMessages()})}ngOnDestroy(){this.messageSubscription&&this.messageSubscription.unsubscribe()}ngAfterViewChecked(){this.scrollToBottom()}goBack(){this.location.back()}loadChatMessages(){this.messagesService.getRoomMessages(this.chat.id).subscribe({next:t=>{this.messages=t},error:()=>{this.toasts.showToast({severity:"error",summary:"Error al obtener mensajes",detail:"No pudimos obtener el historial del chat, intente nuevamente..."})}})}sendMessage(t){if(t&&t.preventDefault(),!this.message.trim())return;let i={mensaje:this.message,idUsuario:this.logedUser.id,idSala:this.chat.id};this.messagesService.sendMessage(i).subscribe({next:e=>{this.message="",this.notificationService.sendNotification({deUsuario:this.logedUser.id,ausuario:this.userChat.id,tipoNotificacion:"NUEVO_MENSAJE",mensaje:`Tienes un nuevo mensaje de ${this.logedUser.alias} en el chat.`}).subscribe()},error:()=>{this.toasts.showToast({severity:"error",summary:"Error al enviar mensaje",detail:"No pudimos enviar tu mensaje, intente nuevamente..."})}})}openCloseChatDialog(){this.confirmationService.confirm({header:"Finalizar chat",message:"Por favor confirma como deseas finalizar el chat.",accept:()=>{this.delivered?this.roomService.closeChat(this.chat.id,!0).subscribe({next:()=>{this.toasts.showToast({severity:"success",summary:"Chat finalizado",detail:"Has finalizado el chat y marcado como entregado."}),this.location.back(),this.chat.estado="ENTREGADO",this.roomService.reloadRooms()},error:()=>{this.toasts.showToast({severity:"error",summary:"Error al finalizar chat",detail:"No pudimos finalizar el chat, intente nuevamente..."})}}):this.roomService.closeChat(this.chat.id,!1).subscribe({next:()=>{this.toasts.showToast({severity:"success",summary:"Chat finalizado",detail:"Has finalizado el chat y marcado como rechazado."}),this.location.back(),this.chat.estado="RECHAZADO",this.roomService.reloadRooms()},error:()=>{this.toasts.showToast({severity:"error",summary:"Error al finalizar chat",detail:"No pudimos finalizar el chat, intente nuevamente..."})}})},reject:()=>{}})}static \u0275fac=function(i){return new(i||r)};static \u0275cmp=S({type:r,selectors:[["app-chat"]],viewQuery:function(i,e){if(i&1&&V(de,5),i&2){let o;N(o=j())&&(e.messagesContainer=o.first)}},features:[D([x])],decls:41,vars:12,consts:[["messagesContainer",""],["headless",""],[1,"main-container","container-fluid","p-0"],[1,"container-fluid","d-flex","flex-column","justify-content-start","align-items-stretch","h-100","p-0"],[1,"d-flex","align-items-center","p-0","py-2","flex-shrink-0","chat-header","mb-2"],[1,"col-auto","ms-2","justify-content-center","d-flex",3,"click"],[1,"pi","pi-chevron-left","go-back-buttom"],[1,"col-auto","mx-2"],["size","large","shape","circle",3,"image"],["size","large","shape","circle","icon","pi pi-user"],[1,"col-auto","d-block","user-display-info"],[1,"fw-medium","fs-4"],[1,"fw-medium","text-secondary","fs-6"],[1,"col-auto","d-block","mx-2","mx-xl-4"],[1,"pi","pi-angle-double-right",2,"font-size","1.5rem"],[1,"col-auto","me-2"],["size","large","shape","circle","icon","pi pi-box"],[1,"col-auto","d-block","product-display-info"],[1,"col","d-flex","justify-content-end","me-2"],["label","Finalizar chat","variant","outlined","severity","danger","raised","true",3,"click","rounded","disabled"],[1,"d-flex","p-0","flex-grow-1","overflow-hidden"],[1,"col","d-flex","flex-column","p-0","h-100","w-100"],[1,"row","d-block","w-100","flex-grow-1","overflow-auto",2,"height","80%","max-height","80%"],[1,"message-container","p-2",3,"ngClass","mt-2"],[1,"row","w-100","mt-2",2,"height","20%","margin-bottom","0.5rem"],[1,"col","p-0"],["placeholder","Escribe un mensaje...","maxlength","255","pTextarea","","fluid","",2,"min-height","100%","max-height","100%","resize","none",3,"ngModelChange","keydown.enter","ngModel","disabled"],[1,"col-auto","d-inline-grid","justify-content-center","align-content-start","align-items-center","p-2","gap-1"],["icon","pi pi-send","variant","outlined","raised","true",3,"click","rounded","disabled"],[1,"message-container","p-2",3,"ngClass"],[1,"fw-medium"],[1,"text-end"],[1,"fw-medium","text-secondary"],[1,"d-flex","flex-column","align-items-center","p-4","rounded","position-relative"],[1,"rounded-circle","d-flex","justify-content-center","align-items-center",2,"height","96px","width","96px","position","absolute","top","-48px","background-color","var(--p-menu-background)"],[1,"pi","pi-question","fs-1"],[1,"mt-5","pt-4","text-center"],[1,"fw-bold","fs-3","d-block","mb-2"],[1,"mb-0"],[1,"d-flex","justify-content-center","align-items-center","gap-2","mt-4"],["label","Entregado","fluid","",3,"click"],["label","Rechazado","fluid","","severity","warn",3,"click"],["label","Cancelar","fluid","","outlined","true",3,"click"]],template:function(i,e){if(i&1){let o=w();a(0,"div",2)(1,"div",3)(2,"div",4)(3,"div",5),h("click",function(){return c(o),m(e.goBack())}),p(4,"i",6),n(),a(5,"div",7),C(6,ue,1,1,"p-avatar",8)(7,pe,1,0,"p-avatar",9),n(),a(8,"div",10)(9,"div")(10,"span",11),d(11),n()(),a(12,"span",12),d(13),n()(),a(14,"div",13),p(15,"i",14),n(),a(16,"div",15),C(17,he,1,1,"p-avatar",8)(18,ge,1,0,"p-avatar",16),n(),a(19,"div",17)(20,"div")(21,"span",11),d(22),n()(),a(23,"span",12),d(24),n()(),a(25,"div",18)(26,"p-button",19),h("click",function(){return c(o),m(e.openCloseChatDialog())}),n()()(),a(27,"div",20)(28,"div",21)(29,"div",22,0),M(31,fe,7,8,"div",23,k),n(),a(33,"div",24)(34,"div",25)(35,"textarea",26),z("ngModelChange",function(v){return c(o),R(e.message,v)||(e.message=v),m(v)}),h("keydown.enter",function(v){return c(o),m(e.sendMessage(v))}),n()(),a(36,"div",27)(37,"p-button",28),h("click",function(){return c(o),m(e.sendMessage())}),n()()()()()()(),a(38,"p-confirmdialog"),E(39,ve,12,2,"ng-template",null,1,U),n()}i&2&&(s(6),y(e.userChat!=null&&e.userChat.urlImagen?6:7),s(5),b(" ",e.userChat==null?null:e.userChat.alias," "),s(2),b(" ",e.userChat==null?null:e.userChat.nombreApellido," "),s(4),y(e.chat!=null&&e.chat.solicitud.producto.urlImagen?17:18),s(5),b(" ",e.chat==null?null:e.chat.solicitud.producto.nombre," "),s(2),b(" ",e.chat==null?null:e.chat.solicitud.producto.categoria.nombre," "),s(2),g("rounded",!0)("disabled",(e.chat==null?null:e.chat.estado)!="PENDIENTE"),s(5),T(e.messages),s(4),P("ngModel",e.message),g("disabled",(e.chat==null?null:e.chat.estado)!="PENDIENTE"),s(2),g("rounded",!0)("disabled",!e.message.trim()||(e.chat==null?null:e.chat.estado)!="PENDIENTE"))},dependencies:[H,L,J,Q,q,G,W,te,ee,re,ne,K,Z,se,oe,F],styles:["@media (max-width: 767px){.main-container[_ngcontent-%COMP%]{padding-top:0!important}.product-display-info[_ngcontent-%COMP%]{display:none!important}.user-display-info[_ngcontent-%COMP%]{max-width:15vw;overflow:hidden;text-overflow:ellipsis}}.go-back-buttom[_ngcontent-%COMP%]{cursor:pointer}.main-container[_ngcontent-%COMP%]   .row[_ngcontent-%COMP%]{margin-right:0;margin-left:0}.message-container[_ngcontent-%COMP%]{border-radius:var(--p-content-border-radius);background-color:var(--p-content-background);width:max-content;max-width:65%}p[_ngcontent-%COMP%]{white-space:normal;word-wrap:break-word;margin:0}.chat-header[_ngcontent-%COMP%]{border-radius:var(--p-content-border-radius);background-color:var(--p-content-background)}"]})};export{me as Chat};
